# PC电脑作旁路由的配置方法


## 基础环境信息

- 旁路由地址: A2,192.168.50.2
- 主路由器地址: A1:192.168.50.1
- 网络环境:
```
局域网-----+--> 主路由器 --> 光猫 ---> 外网
           |
旁路由-----+
```
- **旁路由**负责**数据转发**和**DNS服务**，主路由负责**DHCP**和**拨号**功能，当然也包含**数据转发**和**DNS服务**功能。
- **单臂路**由是主路由的变形, 单网口虚拟出两个接口(LAN和WAN)，负责 拨号、DHCP、DNS服务和数据转发，跟主路由的唯一区别就是网口数量差别。


## 主要的配置逻辑规则

1. 修改DHCP分配的默认网关为 旁路由地址A2,默认情况局域网所有请求都自动转发给了旁路由处理。
2. 旁路由配置LAN接口: 静态IP地址为A2,网关为主路由地址A1即可。


## 详细操作步骤


### 安装OpenWRT系统
> 此系统适用大多数单个LAN网口的**X86_64架构**设备(台式机/VBox或VMWare虚拟机/软路由设备),当然原理上也适用其他架构设备，但编译的软件程序就需要与对应架构类型保持一致。


这里演示环境为**VirtualBox虚拟机**，接下来介绍创建虚拟机过程。

#### 准备固件文件

1. 下载软路由系统镜像(固件),此例下载地址 [支持Koolshare软件中心的LEDE_X64固件](https://fw.koolcenter.com/LEDE_X64_fw867/)，下载版本**2.37**，文件名[openwrt-koolshare-router-v2.37-r17471-8ed31dafdf-x86-64-generic-squashfs-combined-efi.img.gz](https://fw.koolcenter.com/LEDE_X64_fw867/2.37/openwrt-koolshare-router-v2.37-r17471-8ed31dafdf-x86-64-generic-squashfs-combined-efi.img.gz)。
2. 解压文件 **openwrt-koolshare-router-v2.37-r17471-8ed31dafdf-x86-64-generic-squashfs-combined-efi.img.gz**,得到 **openwrt-koolshare-router-v2.37-r17471-8ed31dafdf-x86-64-generic-squashfs-combined-efi.img**文件，Windows系统自动软件识别，Linux/Mac可以用命令 `gunzip`搞定。
3. 为了让固件可以在 **VirtualBox**上使用，还需要将**img**文件转化为 **vdi**磁盘文件类型，命令为: `VBoxManage convertfromraw  openwrt-koolshare-router-v2.37-r17471-8ed31dafdf-x86-64-generic-squashfs-combined-efi.img  openwrt-koolshare-router.vdi`, 这样就得到了**openwrt-koolshare-router.vdi**文件(之后当作软路由的磁盘文件)。

#### 开始安装OpenWRT软路由系统

主要虚拟硬件环境说明: 
- CPU处理器: 1-2(看你自己宿主资源分配)
- 内存: 1GB/2GB/4GB 均可
- 网卡: 1个桥接类型网卡(与宿主机同网段IP地址)



1. 打开 **virtualbox**软件，新建虚拟机：起个名称**软路由1**,类型为 **Linux**,版本为**Linux 2.6/3.x/4.x(64bit)**，内存 **4096 MB**, 虚拟硬盘选择已有虚拟硬盘文件(注册刚得到的**openwrt-koolshare-router.vdi**文件获得虚拟硬盘)，点击 **创建** 完成生成虚拟机。
2. 先设置一下**网卡1(LAN1)**,连接方式为**桥接网卡**,网卡接口选择**eth0(本地网卡1)**，如果想调整CPU数量，点击**系统-->处理器**，调整数量为 **4 CPU**，确定。
3. 开始正式启动 **软路由1**，启动成功后自动登录root用户后台终端，通常默认网卡的静态IP地址为**192.168.1.1**，我们修改一个跟宿主主机同网段且没有使用中的IP地址，此例为**192.168.50.4**，执行命令: 
   
   uci set network.lan.ipaddr='192.168.50.4'
   uci commit
   /etc/init.d/network restart

4. Web页面登录，访问网址:**http://192.168.50.4**, 输入默认密码 **koolshare**(不同固件发布者会有不一样的密码哦)。
5. 配置**网络-接口**, 删除**WAN**和**WAN6**接口，然后点击**编辑**按钮修改**LAN**配置，静态地址:`192.168.50.4`，**IPv4网关**和**DNS服务器**设置为路由器地址`192.168.50.1`，保存，然后**保存并应用**使修改信息生效，只留下**LAN**接口即可。


到这里，我们已经完成软路由系统的安装和配置了。

### 让软路由接管内网通信数据

>现在**软路由**已经准备好了，剩下的问题是如何让软路由接管内网所有主机、手机及各种联网设备的通信数据了。

让软路由接管内网通信数据非常简单，只需要修改 **主路由器**的**DHCP服务器**信息来实现，具体修改内容如下:

1. 登录主路由器Web管理后台，以华硕路由器固件为例，选择 **内部网络(LAN)->DHCP服务器**。
2. 接管内部网络通信: 修改**默认网关**为 **软路由1**的IP地址(此例为 192.168.50.4)。
3. 接管内部DNS请求: 修改**DNS server1**为 **软路由1**的IP地址(此例为 192.168.50.4)。
4. 保存配置并生效，点击**应用本页面设置**，此时会重启主路由的**dnsmasq**服务，内网主机都会自动重新获取IP地址、默认网关和DNS服务器。

此时，**软路由1**开始正式工作啦！看看网络流量监控页面，正常情况下已经有通信数据了。

若到这里**软路由1**没有任何消息，那就按照上面步骤一点点找原因吧，可能哪个细节配置错误导致的。


#### 网上的很多疑问DHCP服务该归属谁？主路由器还是软路由器

大家可以看到，本教程里的DHCP服务是放在了**主路由器**了。

有些小白不理解**DHCP服务**的作用，这里简单介绍下，**DHCP协议**全称**动态主机设置协议**,你的电脑默认情况下没有配置网卡信息，开机时电脑是**自动获取**一个可用家庭局域网IP地址、默认网关和默认DNS服务器，怎么获取？

1. 广播消息: 网络中有**DHCP服务**吗，请给我分配一个网络配置信息？此消息同一个网络环境(路由器或交换机)内的网络设备**都可以收到**。
2. **DHCP服务器**收到请求后发出**分配结果确认**: 通知发送者的消息内容有，你的IP地址为**192.168.50.10**、网关为**192.168.50.4**、默认DNS服务器为**192.168.50.4**和**192.168.50.1**等等信息。
3. 你的电脑根据收到内容自动配置了网卡信息，接下来你就可以正常上网了。


说了这么多，其实DHCP就是管理内网IP分配、默认网关、DNS服务器等信息的。

那可以有多个**DHCP服务器**么？ 就是 **主路由器** 和 **软路由** 都开启DHCP服务，答案是可以，但不建议这样配置。

为什么不建议呢？ 可能会导致你的**IP地址不固定**，两个DHCP服务给同一个主机分配两个不同的IP地址时，先收到谁的消息就用谁的IP地址，这相当于一个公司两个CEO一样，一言不合就会打架的。

当然，如果你对IP地址不固定这样的结果无所谓，那开两个DHCP服务器是没问题，但某些设备你希望有固定IP时建议只保留**主路由器**的DHCP服务即可。











## 最后

**旁路由**优点：

- 数据处理能力更强,**旁路由**的CPU通常比**主路由**更强，可以安装更多软件功能。
- 内存更大，主路由器通常最多512MB或1GB内存，限制只能启动少量的软件进程。
- 分担 **主路由** 的压力，CPU、内存等不足就会导致路由器无法工作。
- 拯救 **主路由**配置低、无法刷新固件问题，主路由器功能弱化了、很便宜的主路由器也无所谓了。


**旁路由**缺点：

- 增加了一些微微的复杂配置，不能接入立即使用。
- **旁路由**一旦关闭，内网将无法工作，意味着虚拟机搭建的软路由和宿主主机要一直开机。
- 需要额外成本，例如购买专门的**旁路由**硬件。


